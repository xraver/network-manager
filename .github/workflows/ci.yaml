name: üêç Python CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: [ "3.12" ]   # add "3.11" if you want multi-version tests

    steps:
      - name: ‚§µÔ∏è Checkout
        uses: actions/checkout@v6

      - name: üêç Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: üßπ Code hygiene (trailing spaces, control chars, EOL)
        shell: bash
        run: |
          set -euo pipefail

          echo "‚ñ∂Ô∏è Check: trailing whitespace (spaces/tabs at end of line)‚Ä¶"
          if grep -RInP --exclude-dir={.git,.venv,venv,__pycache__,node_modules,dist,build,tmp,.mypy_cache,.pytest_cache} "[ \t]$" .; then
            echo "‚ùå Trailing whitespace detected. Please remove trailing spaces/tabs."; exit 1
          else
            echo "‚úÖ No trailing whitespace."
          fi

          echo "‚ñ∂Ô∏è Check: non-printable control characters (except TAB and LF)‚Ä¶"
          # Range: 0x00‚Äì0x08, 0x0B, 0x0C, 0x0E‚Äì0x1F, 0x7F (DEL)
          if grep -RInP --binary-files=without-match --exclude-dir={.git,.venv,venv,__pycache__,node_modules,dist,build,tmp,.mypy_cache,.pytest_cache} "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]" .; then
            echo "‚ùå Disallowed control characters found."; exit 1
          else
            echo "‚úÖ No disallowed control characters."
          fi

          echo "‚ñ∂Ô∏è Check: final newline at end of file‚Ä¶"
          failed=0
          while IFS= read -r -d '' f; do
            # Skip binaries
            if file "$f" | grep -qE 'binary'; then continue; fi
            # If non-empty file, verify last byte == newline (0x0a)
            if [ -s "$f" ]; then
              lastchar=$(tail -c1 "$f" | od -An -t x1 | tr -d ' \n')
              if [ "$lastchar" != "0a" ]; then
                echo "‚ùå Missing final newline: $f"
                failed=1
              fi
            fi
          done < <(git ls-files -z \
                    ':!:dist/*' ':!:build/*' ':!:out/*' ':!:node_modules/*' \
                    ':!:*.png' ':!:*.jpg' ':!:*.jpeg' ':!:*.gif' ':!:*.pdf' ':!:*.ico' \
                    ':!:*.zip' ':!:*.gz' ':!:*.7z' ':!:*.tar' ':!:*.tgz' ':!:*.mp4' ':!:*.mov')
          if [ "$failed" -ne 0 ]; then
            echo "‚ùå Some files do not end with a newline."; exit 1
          else
            echo "‚úÖ All files end with a newline."
          fi

          echo "‚ñ∂Ô∏è Check: mixed/undesired CRLF line endings‚Ä¶"
          if git grep -I -n $'\r' -- . ':!*.bat' ':!*.cmd' ':!*.ps1' ':!*.sln' ':!*.vcxproj' ':!*.csproj' ':!node_modules/*' ':!dist/*' ':!build/*' | grep -vE '\.gitattributes:'; then
            echo "‚ùå CRLF line endings detected where LF is expected. Consider using .gitattributes."; exit 1
          else
            echo "‚úÖ Line endings are consistent."
          fi

      - name: üß™ Lint (flake8 if present)
        run: |
          if python -c "import flake8" 2>/dev/null; then
            if [ -d backend ]; then flake8 backend || exit 1; else flake8 . || exit 1; fi
          else
            echo "‚ÑπÔ∏è flake8 not installed, skipping"
          fi

      - name: ‚úÖ Tests (pytest if present)
        env:
          CI: "true"
        run: |
          if python -c "import pytest" 2>/dev/null; then
            mkdir -p tmp
            pytest -q || exit 1
          else
            echo "‚ÑπÔ∏è pytest not installed, skipping"
          fi

      - name: üöÄ Build (if you have a script)
        run: |
          if [ -f Makefile ] && grep -q "^build:" Makefile; then
            make build
          elif [ -f package.json ]; then
            npm ci || true
            npm run build --if-present
          else
            echo "‚ÑπÔ∏è No build to run"
          fi

      - name: üì¶ Upload artifact (dist/build)
        uses: actions/upload-artifact@v6
        with:
          name: build-${{ github.sha }}
          path: |
            dist
            build
            out
          if-no-files-found: ignore
